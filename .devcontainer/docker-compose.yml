services:
  db:
    build:
      context: ..
      dockerfile: .devcontainer/db.dockerfile
    container_name: kosvitae-db
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: kosvitae
    ports:
      - "5432:5432"
    volumes:
      - pg_data:/var/lib/postgresql/data
      - ../db/init:/docker-entrypoint-initdb.d:ro
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-postgres} -d ${POSTGRES_DB:-kosvitae} -h 127.0.0.1"]
      interval: 5s
      timeout: 5s
      start_period: 20s
      retries: 30

  pgtap:
    image: ringingmountain/pgtap
    container_name: kosvitae-pgtap
    depends_on:
      db:
        condition: service_healthy
    environment:
      PGHOST: db
      PGPORT: 5432
      PGUSER: postgres
      PGPASSWORD: postgres
      PGDATABASE: kosvitae
    volumes:
      - ../db/tests:/tests:ro
    # Roda todos *.sql dos testes (pode filtrar por pasta)
    command: ["bash", "-lc", "pg_prove -v /tests/**/*.sql"]
      
  pgadmin:
    image: dpage/pgadmin4:8
    container_name: kosvitae-pgadmin
    environment:
      PGADMIN_DEFAULT_EMAIL: dev@local.test
      PGADMIN_DEFAULT_PASSWORD: admin
    ports:
      - "5050:80"
    depends_on:
      db:
        condition: service_healthy

  flyway:
    image: flyway/flyway:10
    container_name: kosvitae-flyway
    depends_on:
      db:
        condition: service_healthy
    volumes:
      - ../db/migrations:/flyway/sql:ro
      - ../db/repeatable:/flyway/repeatable:ro
      - ../db/seed:/flyway/seed:ro
      - ../db/flyway.base.conf:/flyway/conf/flyway.base.conf:ro
      - ../db/flyway.dev.conf:/flyway/conf/flyway.dev.conf:ro
    command: >
      -configFiles=/flyway/conf/flyway.base.conf,/flyway/conf/flyway.dev.conf
      -locations=filesystem:/flyway/sql,filesystem:/flyway/repeatable,filesystem:/flyway/seed
      -connectRetries=10
      migrate


  api:
    build:
      context: ..
      dockerfile: .devcontainer/api.dockerfile
    container_name: kosvitae-api
    command: ["bash","-lc","cd apps/api && /home/vscode/.venv/bin/uvicorn app:app --host 0.0.0.0 --port 8000 --reload"]
    environment:
      DATABASE_URL: postgresql+psycopg://postgres:postgres@db:5432/kosvitae
      PYTHONUNBUFFERED: "1"
    volumes:
      - ..:/workspaces/kos-vitae:cached
      - api_venv:/home/vscode/.venv
    ports:
      - "8000:8000"
    depends_on:
      db:
        condition: service_healthy

  web:
    build:
      context: ..
      dockerfile: .devcontainer/web.dockerfile
    container_name: kosvitae-web
    command: ["bash","-lc","cd apps/web && npm run dev"]
    environment:
      NEXT_PUBLIC_API_URL: http://localhost:8000
      NODE_ENV: development
    volumes:
      - ..:/workspaces/kos-vitae:cached
      - web_node_modules:/workspaces/kos-vitae/apps/web/node_modules
    ports:
      - "3000:3000"
    depends_on:
      api:
        condition: service_started
      db:
        condition: service_started

volumes:
  web_node_modules:
  api_venv:
  pg_data:
